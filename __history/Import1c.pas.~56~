unit Import1c;

interface

uses
  System.SysUtils, IOUtils, System.Types, Vcl.Dialogs, System.Classes,
  System.Generics.Collections, INIFiles, Vcl.Forms;

const
  INI_IMPORT1C: string = 'import1c.ini';
  INI_IMPORT1C_DIVISION: string = 'IMPORT1C_DIVISION';
  INI_IMPORT1C_EMPLOYEE: string = 'IMPORT1C_EMPLOYEE';

type

  TDivisionImport1C = class
  private
    fid: string;
    fpid: string;
    fname: string;
  public
    property id: string read fid;
    property pid: string read fpid;
    property name: string read fname;
    constructor Create(id, pid, name: string);
  end;

  TEmployeeImport1C = class
  private
    fid: string;
    flastname: string;
    ffirstname: string;
    fmiddlename: string;
    fdivison_id: string;
    fposition_name: string;
    fcode: string;
    fgender: boolean;
    fbirtdate: TDate;
    fstatus: string;
  public

  end;

  TImport1CInfo = record
    employee_filename: string;
    employee_file: TStringList;
    employee_date: string;
    employee_header: TStringList;

    division: string;
    division_date: string;
    division_header: TStringList;

    procedure Update;
  end;

function GetFileName(filename, path: string): string;

function Import1C_GetIniFile: TIniFile;
//function GetDivisionFileName: string;
//function GetEmployeeFileName: string;
//procedure GetHeaderDivision(var list: TStringList);
//procedure GetHeaderEmployee(var list: TStringList);
function GetHeaderFile(filename: TStringList): TStringList;
function GetHashDivision: TDictionary<string, TDivisionImport1C>;
function GetHashMapFromINI(section: string): TDictionary<string, string>;

implementation

uses db_datamodule;

var
  conf: TGlobalConfig;
  Import1CInfo: TImport1CInfo;

function GetFile(filename: string): TStringList;
var
  f: TStringList;
begin
  f := TStringList.Create;
  try
    f.LoadFromFile(filename);
  except

  end;
  result := f;
end;

function GetLastFile(path, pattern: string): string;
var
  SDA: TStringDynArray;
  name: string;
  lastdate, current: integer;
begin
  result := '';
  try
    SDA := TDirectory.GetFiles(path, pattern);
    lastdate := 0;
    for name in SDA do
    begin
      current := FileAge(name);
      if current > lastdate then
      begin
        result := name;
        lastdate := current;
      end;
    end;
  except
    on E: Exception do
      MessageDlg(E.ClassName + ':' + E.Message, mtError, [mbOK], 0);
  end;
end;

function GetFileName(filename, path: string): string;
begin
  result := '';
  if FileExists(filename) then
    result := filename
  else
  begin
    result := GetLastFile(path, filename);
  end;
end;

function GetHeaderFile(filename: TStringList): TStringList;
var
  f: TStringList;
begin
  f := TStringList.Create;
  filename.Delimiter := ';';
  if filename.Count <> 0 then
    f.DelimitedText := filename[0];
  result := f;
end;

function Import1C_GetIniFile: TIniFile;
var
  ini: TIniFile;
begin
  ini := TIniFile.Create(ExtractFilePath(Application.ExeName) + INI_IMPORT1C);
  result := ini;
end;

function GetHashMapFromINI(section: string): TDictionary<string, string>;
var
  map: TDictionary<string, string>;
  f: TStringList;
  ini: TIniFile;
  s: string;
begin
  map := TDictionary<string, string>.Create;
  f := TStringList.Create;
  ini := Import1C_GetIniFile;
  ini.ReadSection(section, f);
  for s in f do
    map.Add(s, ini.ReadString(section, s, ''));
  f.Free;
  ini.Free;
  result := map;
  map.Values
end;

function GetHashDivision: TDictionary<string, TDivisionImport1C>;
var
  map: TDictionary<string, TDivisionImport1C>;
begin
  map := TDictionary<string, TDivisionImport1C>.Create;

  result := map;
end;


//
//function GetDivisionFileName: string;
//begin
//  result := '';
//  conf := DBDataModule.LoadConfig;
//  if FileExists(conf.Import1CFileDivision) then
//    result := conf.Import1CFileDivision
//  else
//  begin
//    result := GetLastFile(conf.Import1CDirectory, conf.Import1CFileDivision);
//  end;
//end;
//
//function GetEmployeeFileName: string;
//begin
//  result := '';
//  conf := DBDataModule.LoadConfig;
//  if FileExists(conf.Import1CFileEmployee) then
//    result := conf.Import1CFileEmployee
//  else
//  begin
//    result := GetLastFile(conf.Import1CDirectory, conf.Import1CFileEmployee);
//  end;
//
//end;

//procedure GetHeaderDivision(var list: TStringList);
//var
//  f: TStringList;
//begin
//  list.Delimiter := ';';
//  f := TStringList.Create;
//  try
//    f.LoadFromFile(GetDivisionFileName);
//    if f.Count <> 0 then
//      list.DelimitedText := f[0];
//  except
//    on E: Exception do
//      MessageDlg(E.ClassName + ':' + E.Message, mtError, [mbOK], 0);
//  end;
//  f.Free;
//end;
//
//procedure GetHeaderEmployee(var list: TStringList);
//var
//  f: TStringList;
//begin
//  list.Delimiter := ';';
//  f := TStringList.Create;
//  try
//    f.LoadFromFile(GetEmployeeFileName);
//    if f.Count <> 0 then
//      list.DelimitedText := f[0];
//  except
//    on E: Exception do
//      MessageDlg(E.ClassName + ':' + E.Message, mtError, [mbOK], 0);
//  end;
//  f.Free;
//end;

{ TDivisionImport1C }

constructor TDivisionImport1C.Create(id, pid, name: string);
begin
  fid := id;
  fpid := pid;
  fname := name;
end;

{ TImport1CInfo }

procedure TImport1CInfo.Update;
var
  conf: TGlobalConfig;
begin
  conf := DBDataModule.LoadConfig;

  employee_filename := GetFileName(conf.Import1CFileEmployee,conf.Import1CDirectory);
  employee_file := GetFile(employee_filename);
  employee_header := GetHeaderFile(employee_file);
  division := GetFileName(conf.Import1CFileDivision,conf.Import1CDirectory);
  if employee_filename <>'' then
    employee_date := Formatdatetime('dd.mm.yyyy',
      FileDateToDateTime(FileAge(employee_filename)))
  else
    employee_date := '';
  if division <> '' then
    division_date := Formatdatetime('dd.mm.yyyy',
      FileDateToDateTime(FileAge(division)))
  else
    division_date := '';
end;

end.
